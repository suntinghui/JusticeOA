<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>最新会议</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />

		<style>
			.footer-page {
				position: relative;
				bottom: 12px;
			}
			
			.item-title {
				color: #333333;
				font-size: 16px;
			}
			
			.item-time {
				color: #555555;
				margin-top: 10px;
			}
			
			.item-address {
				color: #555555;
				margin-top: 10px;
			}
		</style>
	</head>

	<body>

		<header class="mui-bar mui-bar-nav" style="background-color: #008FF7;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: #FFFFFF;"></a>
			<h1 class="mui-title" style="color: #FFFFFF;">最新会议</h1>
		</header>

		<footer class="mui-bar mui-bar-footer">
			<div class="mui-content-padded footer-page">
				<ul class="mui-pager">
					<li class="mui-previous">
						<a href="#" id="prePage">
							上一页
						</a>
					</li>
					<li class="mui-content-padded">
						<a href="#" style="color: #666666;" id="selectPage">
							1/1
						</a>
					</li>
					<li class="mui-next">
						<a href="#" id="nextPage">
							下一页
						</a>
					</li>
				</ul>
			</div>
		</footer>

		<div class="mui-content">
			<ul class="mui-table-view mui-table-view-striped mui-table-view-condensed" id="list">
			</ul>
		</div>

		<script src="../js/mui.min.js"></script>
		<script type="text/javascript" src="../js/constants.js"></script>

		<script type="text/javascript">
			var currentPage = 1; // 当前页码
			var totalRecord = 0; // 数据总条数
			var totalPages = 1; // 总页数

			mui.init();

			window.onload = function() {
				requestLastestList();
			};

			function requestLastestList() {
				var pageInfo = {
					CurrentPage: currentPage,
					PageSize: PAGE_SIZE
				};
				var searchInfo = {
					MettingId: "",
					MettingTitle: "",
					MettingAddress: "",
					MettingTypeId: "",
					MettingTypeName: "",
					Participant: "",
					StartDate: "",
					EndDate: "",
					ContentType: "",
					HtmlContent: "",
					ByteContent: "",
					HtmlUrl: ""
				};

				var url = HOST + "Meeting.ashx?Commond=GetNewestMeeting&pageInfo=" + JSON.stringify(pageInfo) + "&searchInfo=" + JSON.stringify(searchInfo) + "&tokenKey=" + window.localStorage.getItem(TokenKey);
				mui.ajax(url, {
					dataType: 'json', //服务器返回json格式数据
					type: 'get', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					headers: {
						'Content-Type': 'application/json'
					},
					success: function(data) {

						console.log(JSON.stringify(data));

						responseLastestList(data);

						mui.plusReady(function() {
							plus.nativeUI.closeWaiting();
							mui.currentWebview.show();
						});
					},
					error: function(xhr, type, errorThrown) {
						console.log(type);

						mui.plusReady(function() {
							plus.nativeUI.closeWaiting();
						});
					}
				});

			};

			function responseLastestList(resp) {
				var list = document.getElementById("list");

				// 首先清空下面的所有结点
				var liNodes = document.getElementsByTagName("li");
				for(var i = 0; i < liNodes.length; i++) {
					list.removeChild(liNodes);
				}

				// 开始添加新的节点
				var fragment = document.createDocumentFragment();
				var li;
				for(var i = 0; i < resp.ListRecord.length; i++) {
					var record = resp.ListRecord[i];
					li = document.createElement('li');
					li.className = 'mui-table-view-cell';
					li.id = record.MettingId;
					li.innerHTML = '<div class="mui-table mui-navigate-right "><div class="mui-table-cell mui-col-xs-11"><p class="mui-ellipsis item-title">' + record.MettingTitle + '</p><p class="mui-ellipsis item-time">会议时间：' + record.StartDate + '</p><p class="mui-ellipsis item-address">会议地点：' + record.MettingAddress + '</p></div></div>';
					fragment.appendChild(li);
				}
				list.appendChild(fragment);

				totalRecord = resp.PageInfo.TotalRecordSize;
				totalPages = Math.ceil(totalRecord / PAGE_SIZE);
				document.getElementById("selectPage").text = currentPage + "/" + totalPages;
			};

			mui('#list').on('tap', 'li', function(e) {
				var id = this.getAttribute("id");
				mui.toast(id);
			});

			document.getElementById("prePage").addEventListener('tap', function(event) {
				if(currentPage == 1) {
					mui.toast("当前已是首页");
					return;
				}

				currentPage--;
				requestLastestList();
			});

			document.getElementById("nextPage").addEventListener('tap', function(event) {
				if(currentPage == totalPages) {
					mui.toast("当前已是尾页");
					return;
				}

				currentPage++;
				requestLastestList();
			});

			document.getElementById("selectPage").addEventListener('tap', function(event) {
				mui.toast("---");
			});
		</script>
	</body>

</html>